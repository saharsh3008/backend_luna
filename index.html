<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Habit Tracker - API Tester</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 720px; margin: 40px auto; }
    .habit { border:1px solid #ddd; padding:10px; margin:8px 0; border-radius:8px; }
    button { padding:6px 10px; margin-right:6px; cursor:pointer; }
    .addBtn { background:#4caf50;color:#fff;border:none;border-radius:4px;}
    .completeBtn{ background:#2196f3;color:#fff;border:none;border-radius:4px;}
    .deleteBtn{ background:#f44336;color:#fff;border:none;border-radius:4px;}
  </style>
</head>
<body>
  <h1>Habit Tracker API Tester</h1>

  <h3>Add New Habit</h3>
  <input id="habitName" placeholder="Habit name..." />
  <button class="addBtn" onclick="addHabit()">Add</button>

  <h3>Habits</h3>
  <div id="habitList">Loading...</div>

  <script>
    const API_BASE = "http://localhost:5000/api";

    async function loadHabits() {
      const listEl = document.getElementById("habitList");
      listEl.innerHTML = "Loading...";
      try {
        const res = await fetch(`${API_BASE}/habits`);
        if (!res.ok) throw new Error("Bad response");
        const habits = await res.json();
        if (!Array.isArray(habits)) {
          listEl.innerHTML = "Unexpected response";
          return;
        }
        listEl.innerHTML = "";
        if (habits.length === 0) listEl.innerHTML = "<em>No habits yet</em>";
        habits.forEach(h => {
          const d = document.createElement("div");
          d.className = "habit";
          d.innerHTML = `
            <strong>${escapeHtml(h.name)}</strong><br>
            Streak: ${h.streak || 0} &nbsp; Last: ${h.lastCompleted || "Never"}<br><br>
            <button class="completeBtn" onclick="completeHabit('${h.id}')">Complete</button>
            <button class="deleteBtn" onclick="deleteHabit('${h.id}')">Delete</button>
          `;
          listEl.appendChild(d);
        });
      } catch (err) {
        console.error(err);
        listEl.innerHTML = "Error connecting to backend.";
      }
    }

    async function addHabit() {
      const name = document.getElementById("habitName").value.trim();
      if (!name) return alert("Enter a habit name");
      try {
        const res = await fetch(`${API_BASE}/habits`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ name })
        });
        if (!res.ok) {
          const err = await res.json().catch(()=>({error:"bad"}));
          return alert("Error: " + (err.error || "could not add habit"));
        }
        document.getElementById("habitName").value = "";
        loadHabits();
      } catch (e) {
        alert("Error connecting to backend.");
      }
    }

    async function completeHabit(id) {
      await fetch(`${API_BASE}/habits/${id}/complete`, { method: "PATCH" });
      loadHabits();
    }

    async function deleteHabit(id) {
      await fetch(`${API_BASE}/habits/${id}`, { method: "DELETE" });
      loadHabits();
    }

    function escapeHtml(s) {
      return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }

    loadHabits();
  </script>
</body>
</html>
